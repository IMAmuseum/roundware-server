(function(e){"use strict";var t="formset";var n=function(r,i){var s=this;this.opts=e.extend({},n.defaults,i);this.$formset=e(r);this.$emptyForm=this.$formset.find(this.opts.emptyForm);this.$body=this.$formset.find(this.opts.body);this.$add=this.$formset.find(this.opts.add);this.formsetPrefix=e(r).data("formset-prefix");this.addForm=e.proxy(this,"addForm");this.$add.click(this.addForm);this.$formset.on("formAdded formDeleted",this.opts.form,e.proxy(this,"checkMaxForms"));this.$forms().each(function(t,n){var r=e(n);s.bindForm(e(this),t)});this.$formset.data(t,this);var o=["animateForms"];e.each(o,function(e,t){if(t in s.opts&&s.opts[t]){s[t]()}})};n.defaults={form:"[data-formset-form]",emptyForm:"script[type=form-template][data-formset-empty-form]",body:"[data-formset-body]",add:"[data-formset-add]",deleteButton:"[data-formset-delete-button]",hasMaxFormsClass:"has-max-forms",animateForms:false};n.prototype.addForm=function(){if(this.hasMaxForms()){throw new Error("MAX_NUM_FORMS reached")}var t=this.totalFormCount();this.$managementForm("TOTAL_FORMS").val(t+1);var n=this.$emptyForm.html().replace(new RegExp("__prefix__","g"),t).replace(new RegExp("<\\\\/script>","g"),"</script>");var r=e(e.parseHTML(n,this.$body.document,true));this.$body.append(r);var i=r.filter(this.opts.form);this.bindForm(i,t);return i};n.prototype.bindForm=function(e,n){var r=this.formsetPrefix+"-"+n;e.data(t+"__formPrefix",r);var i=e.find("[name="+r+"-DELETE]");i.change(function(t){if(i.is(":checked")){e.attr("data-formset-form-deleted","");e.trigger("formDeleted")}else{e.removeAttr("data-formset-form-deleted");e.trigger("formAdded")}}).trigger("change");var s=e.find(this.opts.deleteButton);s.bind("click",function(){i.attr("checked",true).change()})};n.prototype.$forms=function(){return this.$body.find(this.opts.form)};n.prototype.$managementForm=function(e){return this.$formset.find("[name="+this.formsetPrefix+"-"+e+"]")};n.prototype.totalFormCount=function(){return this.$forms().length};n.prototype.deletedFormCount=function(){return this.$forms().filter("[data-formset-form-deleted]").length};n.prototype.activeFormCount=function(){return this.totalFormCount()-this.deletedFormCount()};n.prototype.hasMaxForms=function(){var e=parseInt(this.$managementForm("MAX_NUM_FORMS").val(),10)||1e3;return this.activeFormCount()>=e};n.prototype.checkMaxForms=function(){if(this.hasMaxForms()){this.$formset.addClass(this.opts.hasMaxFormsClass);this.$add.attr("disabled","disabled")}else{this.$formset.removeClass(this.opts.hasMaxFormsClass);this.$add.removeAttr("disabled")}};n.prototype.animateForms=function(){this.$formset.on("formAdded",this.opts.form,function(){var t=e(this);t.slideUp(0);t.slideDown()}).on("formDeleted",this.opts.form,function(){var t=e(this);t.slideUp()});this.$forms().filter("[data-formset-form-deleted]").slideUp(0)};n.getOrCreate=function(r,i){var s=e(r).data(t);if(!s){s=new n(r,i)}return s};e.fn[t]=function(){var t,r,i;if(arguments.length===0||arguments.length===1&&e.type(arguments[0])!="string"){t=arguments[0];return this.each(function(){return n.getOrCreate(this,t)})}r=arguments[0];i=e.makeArray(arguments).slice(1);if(r in n){i.unshift(this);return n[r].apply(n,i)}else{throw new Error("Unknown function call "+r+" for $.fn.formset")}}})(jQuery)